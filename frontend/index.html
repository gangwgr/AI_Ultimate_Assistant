<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ultimate Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
        }
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .assistant-message {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .voice-button:hover {
            transform: scale(1.1);
        }
        .voice-button.recording {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Settings Modal Styles */
        #settings-modal {
            display: none;
        }
        
        #settings-modal.show {
            display: flex !important;
        }
        
        .settings-tab.active {
            border-bottom-width: 2px;
            border-color: #3b82f6;
            color: #2563eb;
        }
        
        .settings-content {
            display: none;
        }
        
        .settings-content.active {
            display: block;
        }
        
        /* Custom In-App Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .notification {
            margin-bottom: 10px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s ease-out forwards;
            position: relative;
        }
        
        .notification.email {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }
        
        .notification.calendar {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }
        
        .notification.meeting {
            background: linear-gradient(135deg, #55a3ff 0%, #003d82 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #60a5fa 0%, #1d4ed8 100%);
            color: white;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
            color: white;
        }
        
        .notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification.slide-out {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        /* Pulsating animation for unread badge */
        .pulse-red {
            animation: pulseRed 2s infinite;
        }
        
        @keyframes pulseRed {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #dc2626; }
            100% { transform: scale(1); }
        }

        /* Settings Modal Tab Styles */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings-tab {
            position: relative;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .settings-tab:hover {
            color: #2563eb;
        }

        input[type="radio"][name="tabs"]:checked + label {
            color: #2563eb;
            border-bottom-color: #3b82f6;
        }

        input[type="radio"][name="tabs"]:checked + label + .tab-content {
            display: block;
        }

        /* Service section styles */
        .service-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }

        .service-section:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Hide radio inputs */
        input[type="radio"][name="tabs"] {
            display: none;
        }

        /* Active tab styles */
        input[type="radio"][name="tabs"]:checked + label {
            color: #2563eb;
            border-bottom: 2px solid #3b82f6;
        }

        /* Tab content visibility */
        .tab-content {
            display: none;
        }

        input[type="radio"][name="tabs"]:checked ~ .tab-content {
            display: block;
        }

        /* Settings tab hover effect */
        .settings-tab {
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .settings-tab:hover {
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
      <!-- In-App Notification Container -->
      <div id="notification-container" class="notification-container"></div>
      

      
      <!-- Settings Modal -->
      <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
          <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 my-8">
              <!-- Modal Header -->
              <div class="flex justify-between items-center p-6 border-b">
                  <h3 class="text-xl font-semibold text-gray-800">
                      <i class="fas fa-cog text-blue-500 mr-2"></i>Settings
                  </h3>
                  <button id="close-settings" class="text-gray-500 hover:text-gray-700">
                      <i class="fas fa-times"></i>
                  </button>
              </div>

              <!-- Tab Navigation -->
              <div class="flex border-b">
                  <input type="radio" name="tabs" id="tab-general" class="hidden" checked>
                  <label for="tab-general" class="tab-label px-6 py-3 text-sm font-medium text-gray-500 cursor-pointer hover:text-blue-500">
                      <i class="fas fa-sliders-h mr-2"></i>General
                  </label>

                  <input type="radio" name="tabs" id="tab-services" class="hidden">
                  <label for="tab-services" class="tab-label px-6 py-3 text-sm font-medium text-gray-500 cursor-pointer hover:text-blue-500">
                      <i class="fas fa-plug mr-2"></i>Services
                  </label>

                  <input type="radio" name="tabs" id="tab-voice" class="hidden">
                  <label for="tab-voice" class="tab-label px-6 py-3 text-sm font-medium text-gray-500 cursor-pointer hover:text-blue-500">
                      <i class="fas fa-microphone mr-2"></i>Voice
                  </label>

                  <input type="radio" name="tabs" id="tab-desktop" class="hidden">
                  <label for="tab-desktop" class="tab-label px-6 py-3 text-sm font-medium text-gray-500 cursor-pointer hover:text-blue-500">
                      <i class="fas fa-desktop mr-2"></i>Desktop
                  </label>
              </div>

              <!-- Tab Content Container -->
              <div class="overflow-y-auto max-h-[60vh]">
                  <!-- General Settings -->
                  <div id="general-settings" class="tab-content p-6">
                      <h4 class="text-lg font-medium text-gray-900 mb-6">General Settings</h4>
                      <div class="space-y-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Backend Server URL</label>
                              <input type="url" id="backend-url-setting" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="http://localhost:8000">
                              <p class="text-xs text-gray-500 mt-1">The URL where your AI Assistant backend is running</p>
                          </div>

                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
                              <select id="theme-setting" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                  <option value="auto">Auto (System)</option>
                                  <option value="light">Light</option>
                                  <option value="dark">Dark</option>
                              </select>
                          </div>

                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">AI Model</label>
                              <div class="flex space-x-2 mb-2">
                                  <select id="ai-model-setting" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                      <option value="">Loading models...</option>
                                  </select>
                                  <button id="refresh-models-btn" class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm" title="Refresh available models">
                                      <i class="fas fa-sync-alt"></i>
                                  </button>
                                  <button id="load-models-manually" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm" title="Load models manually">
                                      Load Models
                                  </button>
                              </div>
                              <p class="text-xs text-gray-500 mt-1">Choose which AI model to use for responses</p>
                              <div class="mt-2">
                                  <button id="switch-model-btn" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm">
                                      <i class="fas fa-exchange-alt mr-2"></i>Switch Model Now
                                  </button>
                                  <span id="model-status" class="ml-3 text-sm text-gray-600"></span>
                              </div>
                          </div>

                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Language</label>
                              <select id="language-setting" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                  <option value="en-US">English (US)</option>
                                  <option value="en-GB">English (UK)</option>
                                  <option value="es-ES">Spanish</option>
                                  <option value="fr-FR">French</option>
                                  <option value="de-DE">German</option>
                              </select>
                          </div>
                      </div>
                  </div>

                  <!-- Services Settings -->
                  <div id="services-settings" class="tab-content p-6">
                      <h4 class="text-lg font-medium text-gray-900 mb-6">Service Configuration</h4>
                      
                      <!-- Google OAuth Section -->
                      <div class="mb-8">
                          <h5 class="text-md font-medium text-gray-800 mb-4">
                              <i class="fab fa-google text-blue-500 mr-2"></i>Google Services
                          </h5>
                          <div class="bg-blue-50 p-4 rounded-lg mb-4">
                              <p class="text-sm text-blue-800">Configure Google OAuth to access Gmail, Calendar, and Contacts</p>
                          </div>
                          <div class="space-y-4">
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 mb-2">Client ID</label>
                                  <input type="text" id="google-client-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-client-id.googleusercontent.com">
                              </div>
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 mb-2">Client Secret</label>
                                  <input type="password" id="google-client-secret" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-client-secret">
                              </div>
                              <div class="flex space-x-2">
                                  <button id="save-google" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Save</button>
                                  <button id="test-google" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Test</button>
                              </div>
                          </div>
                      </div>

                      <!-- GitHub Section -->
                      <div class="mb-8">
                          <h5 class="text-md font-medium text-gray-800 mb-4">
                              <i class="fab fa-github text-gray-700 mr-2"></i>GitHub Integration
                          </h5>
                          <div class="bg-gray-50 p-4 rounded-lg mb-4">
                              <p class="text-sm text-gray-800">Configure GitHub token for AI-powered code reviews and repository management</p>
                          </div>
                          <div class="space-y-4">
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 mb-2">Personal Access Token</label>
                                  <input type="password" id="github-token" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                                  <p class="text-xs text-gray-500 mt-1">Create at: GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens</p>
                              </div>
                              <div class="flex space-x-2">
                                  <button id="save-github" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Save</button>
                                  <button id="test-github" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Test</button>
                                  <button id="remove-github" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Remove</button>
                              </div>
                              <div class="bg-yellow-50 p-3 rounded-lg">
                                  <h6 class="text-sm font-medium text-yellow-800 mb-2">Token Requirements</h6>
                                  <ul class="text-xs text-yellow-700 space-y-1">
                                      <li>‚Ä¢ repo - Full control of private repositories</li>
                                      <li>‚Ä¢ public_repo - Access to public repositories</li>
                                      <li>‚Ä¢ issues - Read/write issue and pull request comments</li>
                                      <li>‚Ä¢ user:email - Access to user email (optional)</li>
                                  </ul>
                              </div>
                              <a href="https://github.com/settings/tokens" target="_blank" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                                  <i class="fas fa-external-link-alt mr-1"></i>Generate Token on GitHub
                              </a>
                          </div>
                      </div>

                      <!-- Jira Section -->
                      <div class="mb-8">
                          <h5 class="text-md font-medium text-gray-800 mb-4">
                              <i class="fas fa-ticket-alt text-red-500 mr-2"></i>Jira Integration
                          </h5>
                          <div class="bg-red-50 p-4 rounded-lg mb-4">
                              <p class="text-sm text-red-800">Configure Jira integration for issue tracking and management</p>
                          </div>
                          <div class="space-y-4">
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 mb-2">Server URL</label>
                                  <input type="url" id="jira-server-url" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://issues.redhat.com" value="https://issues.redhat.com">
                              </div>
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                  <input type="text" id="jira-username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-jira-username">
                              </div>
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 mb-2">API Token</label>
                                  <input type="password" id="jira-api-token" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-jira-api-token">
                              </div>
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 mb-2">Authentication Method</label>
                                  <select id="jira-auth-method" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                      <option value="basic">Basic Auth</option>
                                      <option value="bearer">Bearer Token</option>
                                  </select>
                              </div>
                              <div class="flex space-x-2">
                                  <button id="save-jira" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Save</button>
                                  <button id="test-jira" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Test</button>
                                  <button id="remove-jira" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Remove</button>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- Voice Settings -->
                  <div id="voice-settings" class="tab-content p-6">
                      <h4 class="text-lg font-medium text-gray-900 mb-6">Voice Settings</h4>
                      <div class="space-y-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Speech Rate</label>
                              <div class="flex items-center space-x-3">
                                  <span class="text-sm text-gray-500">Slow</span>
                                  <input type="range" id="settings-speech-rate" min="50" max="300" value="150" class="flex-1">
                                  <span class="text-sm text-gray-500">Fast</span>
                              </div>
                              <div class="text-xs text-gray-500 mt-1">Current: <span id="settings-rate-value">150</span></div>
                          </div>

                          <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">Volume</label>
                              <div class="flex items-center space-x-3">
                                  <span class="text-sm text-gray-500">Quiet</span>
                                  <input type="range" id="settings-speech-volume" min="0" max="1" step="0.1" value="0.9" class="flex-1">
                                  <span class="text-sm text-gray-500">Loud</span>
                              </div>
                              <div class="text-xs text-gray-500 mt-1">Current: <span id="settings-volume-value">0.9</span></div>
                          </div>

                          <div>
                              <button id="settings-test-voice" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                                  <i class="fas fa-volume-up mr-1"></i>Test Voice
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Desktop Settings -->
                  <div id="desktop-settings" class="tab-content p-6">
                      <h4 class="text-lg font-medium text-gray-900 mb-6">Desktop Settings</h4>
                      <div class="space-y-6">
                          <div class="flex items-center justify-between">
                              <div>
                                  <label class="text-sm font-medium text-gray-700">Auto-launch on startup</label>
                                  <p class="text-xs text-gray-500">Start AI Assistant when your computer boots</p>
                              </div>
                              <input type="checkbox" id="auto-launch-setting" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                          </div>

                          <div class="flex items-center justify-between">
                              <div>
                                  <label class="text-sm font-medium text-gray-700">Enable notifications</label>
                                  <p class="text-xs text-gray-500">Show desktop notifications for emails and events</p>
                              </div>
                              <input type="checkbox" id="notifications-setting" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                          </div>

                          <div class="flex items-center justify-between">
                              <div>
                                  <label class="text-sm font-medium text-gray-700">Minimize to tray</label>
                                  <p class="text-xs text-gray-500">Hide to system tray instead of taskbar</p>
                              </div>
                              <input type="checkbox" id="minimize-tray-setting" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Modal Footer -->
              <div class="flex justify-end space-x-3 p-6 border-t bg-gray-50">
                  <button id="settings-cancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                      Cancel
                  </button>
                  <button id="settings-save" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                      <i class="fas fa-save mr-1"></i>Save Changes
                  </button>
              </div>
          </div>
      </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-robot text-blue-500"></i> AI Ultimate Assistant
            </h1>
            <p class="text-gray-600">Manage your Gmail, Calendar, Contacts, and Slack with voice and text</p>
            
            <!-- Navigation Links -->
            <div class="mt-4 flex justify-center space-x-6">
                <a href="/" class="text-blue-500 hover:text-blue-700 font-medium">
                    <i class="fas fa-home mr-1"></i>Home
                </a>
                <a href="/frontend/model_trainer.html" class="text-purple-500 hover:text-purple-700 font-medium">
                    <i class="fas fa-brain mr-1"></i>Model Trainer
                </a>
                <a href="/frontend/pr_reviewer.html" class="text-indigo-500 hover:text-indigo-700 font-medium">
                    <i class="fas fa-code-branch mr-1"></i>PR Reviewer
                </a>
                <a href="/frontend/report_portal.html" class="text-orange-500 hover:text-orange-700 font-medium">
                    <i class="fas fa-chart-line mr-1"></i>Report Portal
                </a>
                <a href="/api/must-gather/ui" class="text-teal-500 hover:text-teal-700 font-medium">
                    <i class="fas fa-database mr-1"></i>Must-Gather Analyzer
                </a>
                <a href="/frontend/multi_model_demo.html" class="text-green-500 hover:text-green-700 font-medium">
                    <i class="fas fa-chart-bar mr-1"></i>Multi-Model Demo
                </a>
                <a href="/docs" class="text-orange-500 hover:text-orange-700 font-medium" target="_blank">
                    <i class="fas fa-book mr-1"></i>API Docs
                </a>
                <a href="/frontend/jira_manager.html" class="text-blue-700 hover:text-red-700 font-medium">
                    <i class="fas fa-ticket-alt mr-1"></i>Jira Manager
                </a>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex justify-between items-center">
                <div class="flex space-x-4">
                    <div class="flex items-center">
                        <i class="fas fa-envelope text-red-500 mr-2"></i>
                        <span id="gmail-status" class="text-sm">Gmail: Disconnected</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-calendar text-blue-500 mr-2"></i>
                        <span id="calendar-status" class="text-sm">Calendar: Disconnected</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-address-book text-green-500 mr-2"></i>
                        <span id="contacts-status" class="text-sm">Contacts: Disconnected</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fab fa-slack text-purple-500 mr-2"></i>
                        <span id="slack-status" class="text-sm">Slack: Disconnected</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fab fa-github text-gray-700 mr-2"></i>
                        <span id="github-integration-status" class="text-sm">GitHub: Disconnected</span>
                </div>
                    <div class="flex items-center">
                        <i class="fas fa-brain text-purple-500 mr-2"></i>
                        <span id="ai-model-status" class="text-sm">AI Model: Loading...</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                <button id="refresh-status" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                    <button id="settings-btn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Chat Interface -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-comments text-blue-500 mr-2"></i>
                        AI Assistant Chat
                    </h2>
                </div>
                
                <!-- Chat Messages -->
                <div id="chat-container" class="chat-container p-4 space-y-4">
                    <div class="flex justify-start">
                        <div class="message-bubble assistant-message text-white p-3 rounded-lg">
                            <p>Hello! I'm your AI Ultimate Assistant. I can help you manage your Gmail, Calendar, Contacts, and Slack. Plus, I can analyze OpenShift must-gather data, troubleshoot clusters, and provide KMS encryption guidance. You can type or use voice commands!</p>
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex space-x-2">
                        <input type="text" id="message-input" 
                               placeholder="Type your message or press Ctrl+Shift+V for voice..." 
                               class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="voice-button" 
                                class="voice-button bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all duration-200 relative"
                                title="Voice input (Ctrl+Shift+V)">
                            <i class="fas fa-microphone"></i>
                            <span id="voice-status" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full opacity-0 transition-opacity duration-200"></span>
                        </button>
                        <button id="voice-toggle" 
                                class="voice-toggle bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all duration-200"
                                title="Toggle voice responses">
                            <i class="fas fa-volume-mute"></i>
                        </button>
                        <button id="send-button" 
                                class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions & Info -->
            <div class="space-y-6">
                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-2">
                        <button class="quick-action w-full text-left p-2 rounded hover:bg-gray-100" data-action="Check my emails">
                            <i class="fas fa-envelope text-red-500 mr-2"></i> Check Emails
                        </button>
                        <button class="quick-action w-full text-left p-2 rounded hover:bg-gray-100" data-action="Show my calendar">
                            <i class="fas fa-calendar text-blue-500 mr-2"></i> View Calendar
                        </button>
                        <button class="quick-action w-full text-left p-2 rounded hover:bg-gray-100" data-action="Search my contacts">
                            <i class="fas fa-address-book text-green-500 mr-2"></i> Search Contacts
                        </button>
                        <button class="quick-action w-full text-left p-2 rounded hover:bg-gray-100" data-action="Check Slack messages">
                            <i class="fab fa-slack text-purple-500 mr-2"></i> Check Slack
                        </button>
                        <button id="check-unread-emails" class="w-full text-left p-2 rounded hover:bg-yellow-100 border border-yellow-300 text-yellow-800 relative">
                            <i class="fas fa-envelope-open-text text-yellow-600 mr-2"></i> Show Unread Emails
                            <span id="unread-badge" class="hidden absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-6 text-center">0</span>
                        </button>
                        <a href="/frontend/model_trainer.html" target="_blank" class="block w-full text-left p-2 rounded hover:bg-purple-100 border border-purple-300 text-purple-800">
                            <i class="fas fa-brain text-purple-600 mr-2"></i> Model Trainer
                        </a>
                    </div>
                    
                    <!-- Service Control -->
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‚öôÔ∏è Service Control</h3>
                        <div class="space-y-2">
                            <button id="restart-notifications" class="w-full text-left p-2 rounded hover:bg-orange-100 border border-orange-300 text-orange-800">
                                <i class="fas fa-redo text-orange-600 mr-2"></i> Restart Notification Service
                            </button>
                            <button id="check-notification-status" class="w-full text-left p-2 rounded hover:bg-gray-100 border border-gray-300 text-gray-800">
                                <i class="fas fa-info-circle text-gray-600 mr-2"></i> Check Service Status
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Suggestions -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Suggestions</h3>
                    <div id="suggestions-container" class="space-y-2">
                        <div class="suggestion p-2 rounded bg-gray-50 text-sm cursor-pointer hover:bg-gray-100" data-suggestion="What can you help me with?">
                            üí° What can you help me with?
                        </div>
                        <div class="suggestion p-2 rounded bg-gray-50 text-sm cursor-pointer hover:bg-gray-100" data-suggestion="Send an email">
                            üìß Send an email
                        </div>
                        <div class="suggestion p-2 rounded bg-gray-50 text-sm cursor-pointer hover:bg-gray-100" data-suggestion="Create a meeting">
                            üìÖ Create a meeting
                        </div>
                    </div>
                </div>

                <!-- PR Review Settings -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-code-branch text-blue-600 mr-2"></i>PR Review Settings
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">AI Model for Reviews</label>
                            <select id="pr-review-model" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="ollama">ü§ñ Ollama (Local) - Fast</option>
                                <option value="gemini">üîç Gemini (Google) - Advanced</option>
                                <option value="openai">üß† OpenAI GPT - High Quality</option>
                                <option value="granite">üíé Granite (IBM) - Enterprise</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Choose AI model for comprehensive PR reviews</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Current:</strong> <span id="current-pr-model">Ollama</span>
                            </p>
                        </div>
                        <button id="test-pr-review" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600">
                            <i class="fas fa-test-tube mr-2"></i> Test PR Review
                        </button>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Voice Settings</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Speech Rate</label>
                            <input type="range" id="speech-rate" min="50" max="300" value="150" class="w-full">
                            <span id="rate-value" class="text-sm text-gray-500">150</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Volume</label>
                            <input type="range" id="speech-volume" min="0" max="1" step="0.1" value="0.9" class="w-full">
                            <span id="volume-value" class="text-sm text-gray-500">0.9</span>
                        </div>
                        <button id="test-voice" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                            <i class="fas fa-volume-up mr-2"></i> Test Voice
                        </button>
                        <button id="test-voice-simple" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 mt-2">
                            <i class="fas fa-volume-up mr-2"></i> Test Voice (Simple)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global function for switching models - must be defined first
        window.switchModelGlobal = async function(provider) {
            console.log('Global switchModel called with provider:', provider);
            const modelStatus = document.getElementById('model-status');
            const switchBtn = document.getElementById('switch-model-btn');
            
            if (modelStatus) modelStatus.textContent = 'Switching...';
            if (switchBtn) switchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/agent/switch-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Save the model selection to localStorage
                    localStorage.setItem('aiModel', provider);
                    
                    // Show success message
                    if (modelStatus) {
                        modelStatus.textContent = `‚úÖ ${data.new_model}`;
                        modelStatus.className = 'ml-3 text-sm text-green-600';
                    }
                    
                    // Show notification
                    alert(`‚úÖ Successfully switched to ${data.new_model}!`);
                    
                    // Update the AI model status in the main UI if available
                    const aiModelStatus = document.getElementById('ai-model-status');
                    if (aiModelStatus) {
                        aiModelStatus.textContent = `AI Model: ${data.new_model}`;
                        aiModelStatus.className = 'text-sm text-green-600';
                    }
                    
                } else {
                    throw new Error('Failed to switch model');
                }
            } catch (error) {
                console.error('Error switching model:', error);
                alert('‚ùå Error switching model: ' + error.message);
                
                if (modelStatus) {
                    modelStatus.textContent = '‚ùå Failed to switch';
                    modelStatus.className = 'ml-3 text-sm text-red-600';
                }
            } finally {
                if (switchBtn) switchBtn.disabled = false;
            }
        };

        // Global function for switching models
        async function switchModelGlobal(provider) {
            console.log('Global switchModel called with provider:', provider);
            const modelStatus = document.getElementById('model-status');
            const switchBtn = document.getElementById('switch-model-btn');
            
            if (modelStatus) modelStatus.textContent = 'Switching...';
            if (switchBtn) switchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/agent/switch-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Save the model selection to localStorage
                    localStorage.setItem('aiModel', provider);
                    
                    // Show success message
                    if (modelStatus) {
                        modelStatus.textContent = `‚úÖ ${data.new_model}`;
                        modelStatus.className = 'ml-3 text-sm text-green-600';
                    }
                    
                    // Show notification
                    alert(`‚úÖ Successfully switched to ${data.new_model}!`);
                    
                    // Update the AI model status in the main UI if available
                    const aiModelStatus = document.getElementById('ai-model-status');
                    if (aiModelStatus) {
                        aiModelStatus.textContent = `AI Model: ${data.new_model}`;
                        aiModelStatus.className = 'text-sm text-green-600';
                    }
                    
                } else {
                    throw new Error('Failed to switch model');
                }
            } catch (error) {
                console.error('Error switching model:', error);
                alert('‚ùå Error switching model: ' + error.message);
                
                if (modelStatus) {
                    modelStatus.textContent = '‚ùå Failed to switch';
                    modelStatus.className = 'ml-3 text-sm text-red-600';
                }
            } finally {
                if (switchBtn) switchBtn.disabled = false;
            }
        }

        class AIAssistant {
            constructor() {
                this.websocket = null;
                this.recognition = null;
                this.isRecording = false;
                this.voiceResponsesEnabled = false;
                
                this.initializeElements();
                this.setupEventListeners();
                this.connectWebSocket();
                this.setupSpeechRecognition();
                this.checkStatus();
                this.updateUnreadEmailCount();
                
                setInterval(() => {
                    this.updateUnreadEmailCount();
                }, 30000);
            }

            initializeElements() {
                this.chatContainer = document.getElementById('chat-container');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.voiceButton = document.getElementById('voice-button');
                this.voiceToggle = document.getElementById('voice-toggle');
                this.refreshStatusButton = document.getElementById('refresh-status');
                this.speechRate = document.getElementById('speech-rate');
                this.speechVolume = document.getElementById('speech-volume');
                this.testVoiceButton = document.getElementById('test-voice');
                this.notificationContainer = document.getElementById('notification-container');
                
                // Settings modal elements
                this.settingsBtn = document.getElementById('settings-btn');
                this.settingsModal = document.getElementById('settings-modal');
                this.closeSettingsBtn = document.getElementById('close-settings');
                this.settingsCancelBtn = document.getElementById('settings-cancel');
                this.settingsSaveBtn = document.getElementById('settings-save');
                this.aiModelSetting = document.getElementById('ai-model-setting');
                this.testModelBtn = document.getElementById('test-model-btn');
                this.unreadBadge = document.getElementById('unread-badge'); // New element
                
                // Jira elements
                this.jiraServerUrl = document.getElementById('jira-server-url');
                this.jiraUsername = document.getElementById('jira-username');
                this.jiraToken = document.getElementById('jira-token');
                this.jiraAuthMethod = document.getElementById('jira-auth-method');
                this.saveJiraCredsBtn = document.getElementById('save-jira-creds');
                this.testJiraConnectionBtn = document.getElementById('test-jira-connection');
                this.removeJiraCredsBtn = document.getElementById('remove-jira-creds');
                this.toggleJiraTokenBtn = document.getElementById('toggle-jira-token');
                this.jiraStatusDiv = document.getElementById('jira-status');
                
                // Setup model controls
                this.setupModelControls();
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                this.voiceButton.addEventListener('click', () => this.toggleVoiceRecording());
                this.voiceToggle.addEventListener('click', () => this.toggleVoiceResponses());
                this.refreshStatusButton.addEventListener('click', () => this.checkStatus());
                
                // Voice activation keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ctrl+Shift+V or Space bar (when input not focused) to activate voice
                    if ((e.ctrlKey && e.shiftKey && e.key === 'V') || 
                        (e.code === 'Space' && document.activeElement !== this.messageInput)) {
                        e.preventDefault();
                        this.toggleVoiceRecording();
                    }
                    // Escape to stop voice recording
                    if (e.key === 'Escape' && this.isRecording) {
                        e.preventDefault();
                        this.stopVoiceRecording();
                    }
                });
                
                // Quick actions
                document.querySelectorAll('.quick-action').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const action = e.currentTarget.dataset.action;
                        this.sendMessage(action);
                    });
                });

                // Suggestions
                document.querySelectorAll('.suggestion').forEach(suggestion => {
                    suggestion.addEventListener('click', (e) => {
                        const text = e.currentTarget.dataset.suggestion;
                        this.messageInput.value = text;
                    });
                });

                // Voice settings
                this.speechRate.addEventListener('input', (e) => {
                    document.getElementById('rate-value').textContent = e.target.value;
                });
                
                this.speechVolume.addEventListener('input', (e) => {
                    document.getElementById('volume-value').textContent = e.target.value;
                });

                this.testVoiceButton.addEventListener('click', () => {
                    this.speakText("Hello! This is a test of the voice synthesis system.");
                });

                // Model switching
                this.aiModelSetting.addEventListener('change', () => this.changeModel());
                this.testModelBtn.addEventListener('click', () => this.testCurrentModel());
                
                // Load available models on settings open
                this.settingsBtn.addEventListener('click', () => {
                    setTimeout(() => this.loadAvailableModels(), 100);
                });
                
                // Also load models when the page loads
                setTimeout(() => this.loadAvailableModels(), 500);
                
                // Switch model button is now set up when settings are opened

                // Notification test buttons
                document.getElementById('test-email-notification').addEventListener('click', () => {
                    this.testNotification('email');
                });
                
                document.getElementById('test-calendar-notification').addEventListener('click', () => {
                    this.testNotification('calendar');
                });
                
                document.getElementById('test-meeting-reminder').addEventListener('click', () => {
                    this.testNotification('meeting');
                });
                
                document.getElementById('check-unread-emails').addEventListener('click', () => {
                    this.checkUnreadEmails();
                });
                
                // Train Model Button
                document.getElementById('train-model-btn').addEventListener('click', () => {
                    console.log('Train model button clicked');
                    alert('Train AI Model button clicked! Opening Model Trainer...');
                    try {
                        window.open('/frontend/model_trainer.html', '_blank');
                    } catch (error) {
                        console.error('Error opening model trainer:', error);
                        // Fallback: try to navigate in same window
                        window.location.href = '/frontend/model_trainer.html';
                    }
                });
                
                // Test Train Button
                document.getElementById('test-train-btn').addEventListener('click', () => {
                    console.log('Test train button clicked');
                    alert('Test Train Button clicked! This button is working.');
                    try {
                        window.open('/frontend/model_trainer.html', '_blank');
                    } catch (error) {
                        console.error('Error opening model trainer from test button:', error);
                        window.location.href = '/frontend/model_trainer.html';
                    }
                });
                
                // Notification Service Control
                document.getElementById('restart-notifications').addEventListener('click', () => this.restartNotificationService());
                document.getElementById('check-notification-status').addEventListener('click', () => this.checkNotificationStatus());
                
                // Settings modal
                this.settingsBtn.addEventListener('click', () => this.openSettings());
                this.closeSettingsBtn.addEventListener('click', () => this.closeSettings());
                this.settingsCancelBtn.addEventListener('click', () => this.closeSettings());
                this.settingsSaveBtn.addEventListener('click', () => this.saveSettings());

                // Settings tabs
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.target.closest('.settings-tab').dataset.tab;
                        this.switchSettingsTab(tabName);
                    });
                });

                // Close modal when clicking outside
                this.settingsModal.addEventListener('click', (e) => {
                    if (e.target === this.settingsModal) {
                        this.closeSettings();
                    }
                });

                // Settings voice controls
                document.getElementById('settings-speech-rate')?.addEventListener('input', (e) => {
                    document.getElementById('settings-rate-value').textContent = e.target.value;
                });
                
                document.getElementById('settings-speech-volume')?.addEventListener('input', (e) => {
                    document.getElementById('settings-volume-value').textContent = e.target.value;
                });
                
                document.getElementById('settings-test-voice')?.addEventListener('click', () => {
                    this.testSettingsVoice();
                });

                // Update unread email count on status bar
                this.updateUnreadEmailCount();
                
                // Jira configuration buttons
                this.saveJiraCredsBtn?.addEventListener('click', () => this.saveJiraCredentials());
                this.testJiraConnectionBtn?.addEventListener('click', () => this.testJiraConnection());
                this.removeJiraCredsBtn?.addEventListener('click', () => this.removeJiraCredentials());
                this.toggleJiraTokenBtn?.addEventListener('click', () => this.toggleJiraTokenVisibility());
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = () => {
                    console.log('WebSocket connected');
                };
                
                this.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('WebSocket message received:', data);
                        
                        // Handle different message types
                        if (data.type === 'notification') {
                            // Show in-app notification
                            this.showInAppNotification(
                                data.notification_type, 
                                data.title, 
                                data.message
                            );
                        } else {
                            // Handle regular chat responses
                            const response = data.response || data;
                            this.addMessage(response, 'assistant');
                            
                            // Speak the response if voice is enabled
                            if (this.voiceResponsesEnabled && response) {
                                this.speakText(response);
                            }
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                        // If it's not JSON, treat as regular message
                        this.addMessage(event.data, 'assistant');
                    }
                };
                
                this.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                this.websocket.onclose = () => {
                    console.log('WebSocket disconnected. Attempting to reconnect...');
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
            }

            setupSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.lang = navigator.language || 'en-US';

                    this.recognition.onstart = () => {
                        console.log('üé§ Voice recognition started');
                        this.showInAppNotification('üé§ Voice Recognition Active', 'Listening... Speak now!', 'info');
                        this.messageInput.placeholder = 'Listening... Speak now!';
                    };

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            }
                        }
                        
                        if (finalTranscript) {
                            console.log('üé§ Voice recognized:', finalTranscript);
                            this.messageInput.value = finalTranscript;
                        this.sendMessage();
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('üé§ Voice recognition error:', event.error);
                        let errorMsg = '';
                        switch(event.error) {
                            case 'network':
                                errorMsg = 'üåê Network connection issue - Speech recognition requires internet';
                                break;
                            case 'not-allowed':
                                errorMsg = 'üö´ Microphone access denied - Please enable microphone permissions';
                                break;
                            case 'no-speech':
                                errorMsg = 'üîá No speech detected - Try speaking more clearly';
                                break;
                            case 'aborted':
                                errorMsg = '‚èπÔ∏è Voice recognition stopped';
                                break;
                            case 'audio-capture':
                                errorMsg = 'üé§ Audio capture failed - Check your microphone';
                                break;
                            default:
                                errorMsg = `‚ùó Voice error: ${event.error}`;
                        }
                        this.showInAppNotification('Voice Recognition Error', errorMsg, 'error');
                        this.stopVoiceRecording();
                    };

                    this.recognition.onend = () => {
                        console.log('üé§ Voice recognition ended');
                        this.stopVoiceRecording();
                        this.messageInput.placeholder = 'Type your message or press Ctrl+Shift+V for voice...';
                    };
                    
                    // Enable voice button and show availability
                    this.voiceButton.disabled = false;
                    this.voiceButton.title = 'Click or press Ctrl+Shift+V for voice input';
                    this.showInAppNotification('üé§ Voice Ready', 'Voice recognition is available! Use Ctrl+Shift+V or click the microphone.', 'success');
                } else {
                    // Voice not supported
                    this.voiceButton.disabled = true;
                    this.voiceButton.title = 'Voice recognition not supported in this browser';
                    this.voiceButton.style.opacity = '0.5';
                    console.warn('üé§ Voice recognition not supported');
                }
            }

            toggleVoiceRecording() {
                if (this.isRecording) {
                    this.stopVoiceRecording();
                } else {
                    this.startVoiceRecording();
                }
            }

            startVoiceRecording() {
                if (this.recognition) {
                    this.isRecording = true;
                    this.voiceButton.classList.add('recording');
                    this.voiceButton.innerHTML = '<i class="fas fa-stop"></i><span id="voice-status" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>';
                    this.voiceButton.style.backgroundColor = '#dc2626'; // red-600
                    try {
                    this.recognition.start();
                    } catch (error) {
                        console.error('Error starting voice recognition:', error);
                        this.showInAppNotification('Voice Error', 'Failed to start voice recognition: ' + error.message, 'error');
                        this.stopVoiceRecording();
                    }
                }
            }

            stopVoiceRecording() {
                if (this.recognition && this.isRecording) {
                    this.isRecording = false;
                    this.voiceButton.classList.remove('recording');
                    this.voiceButton.innerHTML = '<i class="fas fa-microphone"></i><span id="voice-status" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full opacity-100 transition-opacity duration-200"></span>';
                    this.voiceButton.style.backgroundColor = '#dc2626'; // red-500
                    this.recognition.stop();
                }
            }

            toggleVoiceResponses() {
                this.voiceResponsesEnabled = !this.voiceResponsesEnabled;
                
                if (this.voiceResponsesEnabled) {
                    this.voiceToggle.classList.remove('bg-gray-500');
                    this.voiceToggle.classList.add('bg-green-500');
                    this.voiceToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                    this.voiceToggle.title = 'Voice responses enabled - Click to disable';
                    this.showInAppNotification('üîä Voice Enabled', 'Assistant will now speak responses aloud', 'success');
                } else {
                    this.voiceToggle.classList.remove('bg-green-500');
                    this.voiceToggle.classList.add('bg-gray-500');
                    this.voiceToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    this.voiceToggle.title = 'Voice responses disabled - Click to enable';
                    this.showInAppNotification('üîá Voice Disabled', 'Assistant will not speak responses', 'info');
                }
            }

            speakText(text) {
                // Only speak if voice responses are enabled
                if (this.voiceResponsesEnabled && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = this.speechRate.value / 100;
                    utterance.volume = parseFloat(this.speechVolume.value);
                    window.speechSynthesis.speak(utterance);
                }
            }

            sendMessage(message = null) {
                const text = message || this.messageInput.value.trim();
                if (!text) return;

                this.addMessage(text, 'user');
                
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(text);
                } else {
                    // Fallback to HTTP API
                    this.sendViaHTTP(text);
                }

                this.messageInput.value = '';
            }

            async sendViaHTTP(message) {
                try {
                    console.log('Sending message via HTTP:', message);
                    const response = await fetch('/api/agent/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message }),
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('HTTP response received:', data);
                        this.addMessage(data.response, 'assistant');
                        
                        // Speak the response if voice is enabled
                        if (this.voiceResponsesEnabled && data.response) {
                        this.speakText(data.response);
                        }
                    } else {
                        console.error('HTTP error:', response.status, response.statusText);
                        this.addMessage('Sorry, I encountered an error processing your request.', 'assistant');
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.addMessage('Connection error. Please try again.', 'assistant');
                }
            }

            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `message-bubble p-4 rounded-lg max-w-4xl ${
                    sender === 'user' ? 'user-message text-white' : 
                    sender === 'assistant' ? 'assistant-message text-white' : 
                    'bg-gray-200 text-gray-800'
                }`;
                
                // Properly render HTML content and format code blocks
                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;';
                
                // Process the text to handle various formatting
                let processedText = text;
                
                // Handle code blocks with backticks
                processedText = processedText.replace(/`([^`]+)`/g, '<code style="background-color: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
                
                // Handle **bold** text
                processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                // Convert <br> and <br/> to actual line breaks
                processedText = processedText.replace(/<br\s*\/?>/gi, '\n');
                
                contentDiv.innerHTML = processedText;
                bubbleDiv.appendChild(contentDiv);
                
                messageDiv.appendChild(bubbleDiv);
                this.chatContainer.appendChild(messageDiv);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            async checkStatus() {
                try {
                    console.log('Checking service status...');
                    const response = await fetch('/api/auth/status');
                    if (response.ok) {
                        const status = await response.json();
                        console.log('Service status received:', status);
                        this.updateStatusDisplay(status);
                        
                        // Update unread email count on status bar
                        this.updateUnreadEmailCount();
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }

            // Custom In-App Notification System
            showInAppNotification(type, title, message) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icons = {
                    email: 'fas fa-envelope',
                    calendar: 'fas fa-calendar-plus',
                    meeting: 'fas fa-clock',
                    info: 'fas fa-info-circle',
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-triangle'
                };
                
                notification.innerHTML = `
                    <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
                    <div class="flex items-start">
                        <i class="${icons[type] || 'fas fa-bell'} text-xl mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-lg">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                            <div class="text-xs mt-2 opacity-75">${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
                
                this.notificationContainer.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.add('slide-out');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, 5000);
            }

            async testNotification(type) {
                try {
                    const response = await fetch(`/api/notifications/test/${type}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.addMessage(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} notification test sent!`, 'assistant');
                        
                        // Show custom in-app notification
                        const notifications = {
                            email: {
                                title: 'üìß New Email Notification Test',
                                message: 'This is a test email notification from AI Assistant'
                            },
                            calendar: {
                                title: 'üìÖ Calendar Invite Notification Test', 
                                message: 'This is a test calendar notification from AI Assistant'
                            },
                            meeting: {
                                title: '‚è∞ Meeting Reminder Test',
                                message: 'This is a test meeting reminder from AI Assistant'
                            }
                        };
                        
                        const notif = notifications[type];
                        this.showInAppNotification(type, notif.title, notif.message);
                    } else {
                        this.addMessage(`‚ùå Failed to send ${type} notification test.`, 'assistant');
                    }
                } catch (error) {
                    console.error('Error testing notification:', error);
                    this.addMessage(`‚ùå Error testing ${type} notification: ${error.message}`, 'assistant');
                }
            }

            async changeModel() {
                const selectedModel = this.aiModelSetting.value;
                await this.switchModel(selectedModel);
            }

                    async switchModel(selectedModel) {
            console.log('switchModel called with model:', selectedModel);
            const modelStatus = document.getElementById('model-status');
            const switchBtn = document.getElementById('switch-model-btn');
            
            console.log('Model status element:', modelStatus);
            console.log('Switch button element:', switchBtn);
            
            if (modelStatus) modelStatus.textContent = 'Switching...';
            if (switchBtn) switchBtn.disabled = true;
            
            // Map model names to providers
            let provider = selectedModel;
            if (selectedModel.includes('granite') || selectedModel.includes('deepseek') || 
                selectedModel.includes('codellama') || selectedModel.includes('mistral') || 
                selectedModel.includes('openshift') || selectedModel.includes('llama')) {
                provider = 'ollama';
            } else if (selectedModel === 'gemini') {
                provider = 'gemini';
            } else if (selectedModel === 'openai') {
                provider = 'openai';
            }
            
            console.log('Mapped provider:', provider);
            
            try {
                const response = await fetch('/api/agent/switch-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider })
                });
                    
                    if (response.ok) {
                        const data = await response.json();
                        // Save the model selection to localStorage
                        localStorage.setItem('aiModel', provider);
                        this.showInAppNotification('success', 'ü§ñ Model Changed', `Successfully switched to ${data.new_model}`);
                        this.addMessage(`ü§ñ AI Model switched to: ${data.new_model}`, 'assistant');
                        
                        if (modelStatus) {
                            modelStatus.textContent = `‚úÖ ${data.new_model}`;
                            modelStatus.className = 'ml-3 text-sm text-green-600';
                        }
                        
                        // Update the AI model status in the main UI
                        this.updateAIModelStatus();
                    } else {
                        throw new Error('Failed to switch model');
                    }
                } catch (error) {
                    console.error('Error switching model:', error);
                    this.showInAppNotification('error', '‚ùå Model Error', 'Failed to switch AI model');
                    
                    if (modelStatus) {
                        modelStatus.textContent = '‚ùå Failed to switch';
                        modelStatus.className = 'ml-3 text-sm text-red-600';
                    }
                } finally {
                    if (switchBtn) switchBtn.disabled = false;
                }
            }

            async testCurrentModel() {
                this.testModelBtn.disabled = true;
                this.testModelBtn.textContent = 'Testing...';
                
                try {
                    const testMessage = "Hello! Please introduce yourself and tell me which AI model you are.";
                    const response = await fetch('/api/agent/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: testMessage })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.addMessage(testMessage, 'user');
                        this.addMessage(data.response, 'assistant');
                        this.showInAppNotification('success', '‚úÖ Model Test', 'Model test completed successfully!');
                    } else {
                        throw new Error('Model test failed');
                    }
                } catch (error) {
                    console.error('Error testing model:', error);
                    this.showInAppNotification('error', '‚ùå Test Failed', 'Could not test the current model');
                } finally {
                    this.testModelBtn.disabled = false;
                    this.testModelBtn.textContent = 'Test Current Model';
                }
            }

            updateStatusDisplay(status) {
                console.log('Updating status display with:', status);
                
                // Update Gmail status (based on Google connection)
                const gmailElement = document.getElementById('gmail-status');
                if (gmailElement) {
                    const connected = status.google;
                    gmailElement.textContent = `Gmail: ${connected ? 'Connected' : 'Disconnected'}`;
                    gmailElement.className = `text-sm ${connected ? 'text-green-600' : 'text-red-600'}`;
                    console.log('Updated Gmail status:', connected);
                }

                // Update Calendar status (based on Google connection)
                const calendarElement = document.getElementById('calendar-status');
                if (calendarElement) {
                    const connected = status.google;
                    calendarElement.textContent = `Calendar: ${connected ? 'Connected' : 'Disconnected'}`;
                    calendarElement.className = `text-sm ${connected ? 'text-green-600' : 'text-red-600'}`;
                    console.log('Updated Calendar status:', connected);
                }
                
                // Update Contacts status (based on Google connection)
                const contactsElement = document.getElementById('contacts-status');
                if (contactsElement) {
                    const connected = status.google;
                    contactsElement.textContent = `Contacts: ${connected ? 'Connected' : 'Disconnected'}`;
                    contactsElement.className = `text-sm ${connected ? 'text-green-600' : 'text-red-600'}`;
                    console.log('Updated Contacts status:', connected);
                }

                // Update Slack status
                const slackElement = document.getElementById('slack-status');
                if (slackElement) {
                    const connected = status.slack;
                    slackElement.textContent = `Slack: ${connected ? 'Connected' : 'Disconnected'}`;
                    slackElement.className = `text-sm ${connected ? 'text-green-600' : 'text-red-600'}`;
                    console.log('Updated Slack status:', connected);
                }

                // Update GitHub status
                const githubElement = document.getElementById('github-integration-status');
                if (githubElement) {
                    const connected = status.github;
                    githubElement.textContent = `GitHub: ${connected ? 'Connected' : 'Disconnected'}`;
                    githubElement.className = `text-sm ${connected ? 'text-green-600' : 'text-red-600'}`;
                    console.log('Updated GitHub status:', connected);
                }
                
                // Update AI model status
                this.updateAIModelStatus();
            }
            
            async updateAIModelStatus() {
                try {
                    const response = await fetch('/api/agent/current-model');
                    if (response.ok) {
                        const data = await response.json();
                        const aiModelElement = document.getElementById('ai-model-status');
                        if (aiModelElement) {
                            aiModelElement.textContent = `AI Model: ${data.model_info}`;
                            aiModelElement.className = 'text-sm text-green-600';
                            console.log('Updated AI model status:', data.model_info);
                        }
                    } else {
                        console.error('Failed to get current model status');
                        const aiModelElement = document.getElementById('ai-model-status');
                        if (aiModelElement) {
                            aiModelElement.textContent = 'AI Model: Unknown';
                            aiModelElement.className = 'text-sm text-gray-600';
                        }
                    }
                } catch (error) {
                    console.error('Error updating AI model status:', error);
                    const aiModelElement = document.getElementById('ai-model-status');
                    if (aiModelElement) {
                        aiModelElement.textContent = 'AI Model: Error';
                        aiModelElement.className = 'text-sm text-red-600';
                    }
                }
            }

        // Settings Modal Functionality
        openSettings() {
            this.loadCurrentSettings();
            this.settingsModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Load Jira config when settings are opened
            this.loadJiraConfig();
            
            // Setup switch model button event listener when settings are opened
            this.setupSwitchModelButton();
        }

        closeSettings() {
            this.settingsModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        switchSettingsTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.settings-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active', 'border-blue-500', 'text-blue-600');
                    tab.classList.remove('text-gray-500');
                } else {
                    tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    tab.classList.add('text-gray-500');
                }
            });

            // Update content
            document.querySelectorAll('.settings-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const activeContent = document.getElementById(`${tabName}-settings`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }

        loadCurrentSettings() {
            // Load saved settings from localStorage
            const theme = localStorage.getItem('theme') || 'auto';
            const aiModel = localStorage.getItem('aiModel') || 'ollama';
            const language = localStorage.getItem('language') || 'en-US';
            
            // Update UI elements
            document.getElementById('theme-setting').value = theme;
            document.getElementById('ai-model-setting').value = aiModel;
            document.getElementById('language-setting').value = language;
            
            // Load current model status
            this.loadCurrentModelStatus();
            
            // Load voice settings
            document.getElementById('settings-speech-rate').value = this.speechRate.value;
            document.getElementById('settings-speech-volume').value = this.speechVolume.value;
            document.getElementById('settings-rate-value').textContent = this.speechRate.value;
            document.getElementById('settings-volume-value').textContent = this.speechVolume.value;
            
            // Load desktop settings
            document.getElementById('auto-launch-setting').checked = localStorage.getItem('autoLaunch') === 'true';
            document.getElementById('notifications-setting').checked = localStorage.getItem('notifications') !== 'false';
            document.getElementById('minimize-tray-setting').checked = localStorage.getItem('minimizeToTray') === 'true';
            document.getElementById('auto-hide-menu-setting').checked = localStorage.getItem('autoHideMenu') === 'true';
            
            // Load service configurations
            this.loadJiraConfig();
            this.loadGitHubConfig();
        }

        setupSwitchModelButton() {
            // Remove any existing event listeners
            const switchModelBtn = document.getElementById('switch-model-btn');
            if (switchModelBtn) {
                // Clone the button to remove all event listeners
                const newSwitchBtn = switchModelBtn.cloneNode(true);
                switchModelBtn.parentNode.replaceChild(newSwitchBtn, switchModelBtn);
                
                // Add new event listener
                newSwitchBtn.addEventListener('click', () => {
                    console.log('Switch model button clicked');
                    const selectedModel = this.aiModelSetting.value;
                    console.log('Selected model:', selectedModel);
                    
                    if (!selectedModel) {
                        alert('Please select a model first');
                        return;
                    }
                    
                    this.switchModel(selectedModel);
                });
                
                console.log('Switch model button event listener set up');
            } else {
                console.error('Switch model button not found in settings');
            }
        }

        async loadCurrentModelStatus() {
            try {
                const response = await fetch('/api/agent/current-model');
                if (response.ok) {
                    const data = await response.json();
                    const modelStatus = document.getElementById('model-status');
                    if (modelStatus) {
                        modelStatus.textContent = `‚úÖ ${data.model_info}`;
                        modelStatus.className = 'ml-3 text-sm text-green-600';
                    }
                    
                    // Update the dropdown to match the current model
                    const aiModelSetting = document.getElementById('ai-model-setting');
                    if (aiModelSetting) {
                        aiModelSetting.value = data.provider;
                    }
                }
            } catch (error) {
                console.error('Error loading current model status:', error);
                const modelStatus = document.getElementById('model-status');
                if (modelStatus) {
                    modelStatus.textContent = '‚ùå Failed to load status';
                    modelStatus.className = 'ml-3 text-sm text-red-600';
                }
            }
        }

        async loadAvailableModels() {
            try {
                console.log('üîÑ Loading available models...');
                const select = document.getElementById('ai-model-setting');
                if (!select) {
                    console.error('‚ùå AI model select element not found');
                    return;
                }
                
                // Show loading state
                select.innerHTML = '<option value="">Loading models...</option>';
                
                // Fetch available models from API
                const response = await fetch('/api/models/available', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'list' })
                });
                
                if (response.ok) {
                    const models = await response.json();
                    console.log('üìã Available models:', models);
                    
                    // Clear and populate dropdown
                    select.innerHTML = '';
                    
                    // Add default options for external providers
                    const externalProviders = [
                        { value: 'gemini', text: 'Google Gemini 2.5 Flash' },
                        { value: 'openai', text: 'OpenAI GPT-4' }
                    ];
                    
                    externalProviders.forEach(provider => {
                        const option = document.createElement('option');
                        option.value = provider.value;
                        option.textContent = provider.text;
                        select.appendChild(option);
                    });
                    
                    // Add separator if we have Ollama models
                    if (models.length > 0) {
                        const separator = document.createElement('option');
                        separator.disabled = true;
                        separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ollama Models ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                        select.appendChild(separator);
                    }
                    
                    // Add Ollama models
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = `ü§ñ ${model}`;
                        select.appendChild(option);
                    });
                    
                    console.log(`‚úÖ Loaded ${models.length} Ollama models + ${externalProviders.length} external providers`);
                    
                    // Set default selection to current model if available
                    const currentModel = localStorage.getItem('aiModel') || 'granite3.3-balanced:latest';
                    if (currentModel && select.querySelector(`option[value="${currentModel}"]`)) {
                        select.value = currentModel;
                    }
                    
                } else {
                    console.error('‚ùå Failed to fetch models:', response.status);
                    select.innerHTML = '<option value="">Error loading models</option>';
                }
                
            } catch (error) {
                console.error('‚ùå Error loading models:', error);
                const select = document.getElementById('ai-model-setting');
                if (select) {
                    select.innerHTML = '<option value="">Error loading models</option>';
                }
            }
        }

        setupModelControls() {
            // Setup refresh models button
            const refreshBtn = document.getElementById('refresh-models-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    this.loadAvailableModels();
                });
            }
            
            // Setup manual load models button
            const manualLoadBtn = document.getElementById('load-models-manually');
            if (manualLoadBtn) {
                manualLoadBtn.addEventListener('click', () => {
                    console.log('üîÑ Manual load models button clicked');
                    this.loadAvailableModels();
                });
            }
            
            // Setup switch model button
            this.setupSwitchModelButton();
            
            // Load models on initialization
            this.loadAvailableModels();
        }

        saveSettings() {
            try {
                // Save general settings
                const theme = document.getElementById('theme-setting').value;
                const aiModel = document.getElementById('ai-model-setting').value;
                const language = document.getElementById('language-setting').value;
                
                localStorage.setItem('theme', theme);
                localStorage.setItem('aiModel', aiModel);
                localStorage.setItem('language', language);
                
                // Save voice settings
                const settingsRate = document.getElementById('settings-speech-rate').value;
                const settingsVolume = document.getElementById('settings-speech-volume').value;
                
                this.speechRate.value = settingsRate;
                this.speechVolume.value = settingsVolume;
                document.getElementById('rate-value').textContent = settingsRate;
                document.getElementById('volume-value').textContent = settingsVolume;
                
                localStorage.setItem('speechRate', settingsRate);
                localStorage.setItem('speechVolume', settingsVolume);
                
                // Save desktop settings
                localStorage.setItem('autoLaunch', document.getElementById('auto-launch-setting').checked);
                localStorage.setItem('notifications', document.getElementById('notifications-setting').checked);
                localStorage.setItem('minimizeToTray', document.getElementById('minimize-tray-setting').checked);
                localStorage.setItem('autoHideMenu', document.getElementById('auto-hide-menu-setting').checked);
                
                // Apply theme
                this.applyTheme(theme);
                
                // Show success message
                this.showInAppNotification('success', 'Settings', 'Settings saved successfully');
                this.closeSettings();
                
            } catch (error) {
                console.error('Error saving settings:', error);
                this.showInAppNotification('error', 'Settings', 'Error saving settings: ' + error.message);
            }
        }

        testSettingsVoice() {
            const rate = document.getElementById('settings-speech-rate').value;
            const volume = document.getElementById('settings-speech-volume').value;
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance("This is a test of the voice settings. The speech rate and volume are working correctly.");
                utterance.rate = rate / 100;
                utterance.volume = parseFloat(volume);
                utterance.lang = navigator.language || 'en-US';
                
                speechSynthesis.speak(utterance);
            }
        }

        applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                // Auto theme based on system preference
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        }

        async saveGoogleCredentials() {
            const clientId = document.getElementById('google-client-id').value.trim();
            const clientSecret = document.getElementById('google-client-secret').value.trim();
            
            if (!clientId || !clientSecret) {
                this.addMessage('‚ùå Please fill in both Google Client ID and Client Secret', 'system');
                return;
            }
            
            try {
                localStorage.setItem('googleClientId', clientId);
                localStorage.setItem('googleClientSecret', clientSecret);
                
                // Also save to backend if available
                const response = await fetch('/api/config/google-credentials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret
                    })
                });
                
                if (response.ok) {
                    this.addMessage('‚úÖ Google credentials saved successfully', 'system');
                } else {
                    throw new Error('Failed to save credentials to backend');
                }
            } catch (error) {
                console.error('Error saving Google credentials:', error);
                this.addMessage('‚ö†Ô∏è Credentials saved locally, but backend save failed: ' + error.message, 'system');
            }
        }

        async testGoogleConnection() {
            try {
                const response = await fetch('/api/auth/google/test');
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    this.addMessage('‚úÖ Google connection test successful', 'system');
                } else {
                    this.addMessage('‚ùå Google connection test failed: Invalid credentials', 'system');
                }
            } catch (error) {
                console.error('Error testing Google connection:', error);
                this.addMessage('‚ùå Google connection test failed: ' + error.message, 'system');
            }
        }

        async saveSlackCredentials() {
            const clientId = document.getElementById('slack-client-id').value.trim();
            const clientSecret = document.getElementById('slack-client-secret').value.trim();
            
            try {
                localStorage.setItem('slackClientId', clientId);
                localStorage.setItem('slackClientSecret', clientSecret);
                
                if (clientId && clientSecret) {
                    // Save to backend if both values provided
                    const response = await fetch('/api/config/slack-credentials', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            client_id: clientId,
                            client_secret: clientSecret
                        })
                    });
                    
                    if (response.ok) {
                        this.addMessage('‚úÖ Slack credentials saved successfully', 'system');
                    } else {
                        throw new Error('Failed to save credentials to backend');
                    }
                } else {
                    this.addMessage('‚úÖ Slack credentials cleared', 'system');
                }
            } catch (error) {
                console.error('Error saving Slack credentials:', error);
                this.addMessage('‚ö†Ô∏è Credentials saved locally, but backend save failed: ' + error.message, 'system');
            }
        }

        async testSlackConnection() {
            try {
                const response = await fetch('/api/auth/slack/test');
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    this.addMessage('‚úÖ Slack connection test successful', 'system');
                } else {
                    this.addMessage('‚ùå Slack connection test failed: Invalid credentials', 'system');
                }
            } catch (error) {
                console.error('Error testing Slack connection:', error);
                this.addMessage('‚ùå Slack connection test failed: ' + error.message, 'system');
            }
        }

        async checkUnreadEmails() {
            try {
                // Use the main Gmail API endpoint instead of notifications endpoint
                const response = await fetch('/api/gmail/emails?query=is:unread in:inbox&max_results=20');
                if (response.ok) {
                    const emails = await response.json();
                    const count = emails.length;
                    
                    if (count > 0) {
                        // Format unread emails for display
                        let emailDisplay = `üìß **Found ${count} Unread Email${count > 1 ? 's' : ''}:**\n\n`;
                        
                        emails.forEach((email, index) => {
                            // Clean sender name
                            let sender = email.sender;
                            if (sender.includes('<') && sender.includes('>')) {
                                sender = sender.split('<')[0].trim().replace(/"/g, '');
                            }
                            
                            emailDisplay += `**${index + 1}. ${email.subject}**\n`;
                            emailDisplay += `From: ${sender}\n`;
                            emailDisplay += `Date: ${email.date}\n`;
                            emailDisplay += `Preview: ${email.snippet}\n\n`;
                            emailDisplay += `${'‚îÄ'.repeat(50)}\n\n`;
                        });
                        
                        this.addMessage(emailDisplay, 'assistant');
                        this.showInAppNotification('info', 'üìß Unread Emails', `Found ${count} unread email${count > 1 ? 's' : ''} in your inbox.`);
                    } else {
                        this.addMessage('‚úÖ No unread emails found in your inbox.', 'assistant');
                        this.showInAppNotification('success', 'üìß Inbox Clear', 'No unread emails found in your inbox.');
                    }
                    
                    this.updateUnreadEmailCount(); // Update badge after checking
                } else {
                    this.addMessage('‚ùå Failed to fetch unread emails.', 'assistant');
                    this.showInAppNotification('error', 'üìß Error', 'Failed to fetch unread emails.');
                }
            } catch (error) {
                console.error('Error fetching unread emails:', error);
                this.addMessage('‚ùå Error fetching unread emails: ' + error.message, 'assistant');
                this.showInAppNotification('error', 'üìß Error', 'Error fetching unread emails.');
            }
        }

        async restartNotificationService() {
            try {
                const response = await fetch('/api/notifications/restart', {
                    method: 'POST'
                });
                const result = await response.json();
                if (response.ok) {
                    this.addMessage('‚úÖ Notification service restarted successfully!', 'system');
                    this.showInAppNotification('info', 'Notification Service', 'Notification service restarted.');
                } else {
                    this.addMessage('‚ùå Failed to restart notification service: ' + result.message, 'system');
                    this.showInAppNotification('error', 'Notification Service', 'Failed to restart notification service.', 'error');
                }
            } catch (error) {
                console.error('Error restarting notification service:', error);
                this.addMessage('‚ùå Error restarting notification service: ' + error.message, 'system');
                this.showInAppNotification('error', 'Notification Service', 'Error restarting notification service.', 'error');
            }
        }

        async checkNotificationStatus() {
            try {
                const response = await fetch('/api/notifications/debug-status');
                const result = await response.json();
                if (response.ok) {
                    const statusMessage = `üìä Service Status:\n` +
                        `‚Ä¢ Running: ${result.is_running ? '‚úÖ Yes' : '‚ùå No'}\n` +
                        `‚Ä¢ Seen Emails: ${result.seen_emails_count}\n` +
                        `‚Ä¢ Gmail Available: ${result.gmail_service_available ? '‚úÖ Yes' : '‚ùå No'}\n` +
                        `‚Ä¢ Last Email Check: ${result.last_email_check ? new Date(result.last_email_check).toLocaleString() : 'Never'}`;
                    
                    this.addMessage(statusMessage, 'system');
                    this.showInAppNotification('info', 'Notification Status', 'Status details added to chat.');
                } else {
                    this.addMessage('‚ùå Failed to check notification status.', 'system');
                    this.showInAppNotification('error', 'Notification Status', 'Failed to check notification status.', 'error');
                }
            } catch (error) {
                console.error('Error checking notification status:', error);
                this.addMessage('‚ùå Error checking notification status: ' + error.message, 'system');
                this.showInAppNotification('error', 'Notification Status', 'Error checking notification status.', 'error');
            }
        }

        updateUnreadEmailCount() {
            fetch('/api/gmail/emails?query=is:unread in:inbox&max_results=20')
                .then(response => response.json())
                .then(emails => {
                    const count = emails.length;
                    this.unreadBadge.textContent = count > 0 ? count.toString() : '';
                    this.unreadBadge.classList.remove('hidden');
                    if (count > 0) {
                        this.unreadBadge.classList.add('pulse-red');
                        // Update button text to show unread count
                        const emailButton = document.getElementById('check-unread-emails');
                        const icon = emailButton.querySelector('i');
                        emailButton.innerHTML = `${icon.outerHTML} ${count} Unread Email${count > 1 ? 's' : ''} <span id="unread-badge" class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-6 text-center pulse-red">${count}</span>`;
                    } else {
                        this.unreadBadge.classList.remove('pulse-red');
                        // Reset button text when no unread emails
                        const emailButton = document.getElementById('check-unread-emails');
                        emailButton.innerHTML = '<i class="fas fa-envelope-open-text text-yellow-600 mr-2"></i> Show Unread Emails <span id="unread-badge" class="hidden absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-6 text-center">0</span>';
                        this.unreadBadge = document.getElementById('unread-badge'); // Re-reference after DOM update
                    }
                })
                .catch(error => {
                    console.error('Error fetching unread email count:', error);
                    this.unreadBadge.textContent = '0';
                    this.unreadBadge.classList.add('hidden');
                });
        }
        
        // GitHub Configuration Methods
        async loadGitHubConfig() {
            try {
                const response = await fetch('/api/github/config');
                if (response.ok) {
                    const data = await response.json();
                    this.updateGitHubStatus(data.github_config);
                } else {
                    console.error('Failed to load GitHub config');
                }
            } catch (error) {
                console.error('Error loading GitHub config:', error);
            }
        }
        
        updateGitHubStatus(config) {
            const statusDiv = document.getElementById('github-status');
            const userInfoDiv = document.getElementById('github-user-info');
            const statusBarElement = document.getElementById('github-integration-status');
            
            if (config.token_configured) {
                statusDiv.className = 'mb-4 p-3 rounded-lg bg-green-50 border border-green-200';
                statusDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-green-700 font-medium">GitHub Integration Configured</span>
                    </div>
                    <div class="text-sm text-green-600 mt-1">
                        Token Source: ${config.token_source === 'environment' ? 'Environment Variable' : 'UI Configuration'}
                        ${config.token_masked ? `‚Ä¢ Token: ${config.token_masked}` : ''}
                    </div>
                `;
                // Update status bar
                statusBarElement.textContent = 'GitHub: Connected';
                statusBarElement.className = 'text-sm text-green-600';
            } else {
                statusDiv.className = 'mb-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200';
                statusDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                        <span class="text-yellow-700 font-medium">GitHub Integration Not Configured</span>
                    </div>
                    <div class="text-sm text-yellow-600 mt-1">
                        Add a GitHub Personal Access Token to enable AI code reviews and repository management.
                    </div>
                `;
                // Update status bar
                statusBarElement.textContent = 'GitHub: Disconnected';
                statusBarElement.className = 'text-sm text-gray-500';
            }
            
            // Hide user info initially
            userInfoDiv.classList.add('hidden');
        }
        
        async saveGitHubToken() {
            const tokenInput = document.getElementById('github-token');
            const token = tokenInput.value.trim();
            
            if (!token) {
                this.showInAppNotification('error', 'GitHub Configuration', 'Please enter a GitHub token');
                return;
            }
            
            try {
                const response = await fetch('/api/github/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'set',
                        token: token
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    this.showInAppNotification('success', 'GitHub Configuration', 'GitHub token saved successfully');
                    this.updateGitHubStatus(result.config_status);
                    
                    // Show user info
                    const userInfoDiv = document.getElementById('github-user-info');
                    if (result.user_info) {
                        userInfoDiv.innerHTML = `
                            <div class="flex items-start">
                                <i class="fab fa-github text-gray-700 mr-3 mt-1"></i>
                                <div>
                                    <div class="font-medium text-green-800">${result.user_info.login}</div>
                                    ${result.user_info.name ? `<div class="text-sm text-green-700">${result.user_info.name}</div>` : ''}
                                    ${result.user_info.email ? `<div class="text-xs text-green-600">${result.user_info.email}</div>` : ''}
                                </div>
                            </div>
                        `;
                        userInfoDiv.classList.remove('hidden');
                    }
                    
                    // Clear the input for security
                    tokenInput.value = '';
                } else {
                    throw new Error(result.detail || 'Failed to save GitHub token');
                }
            } catch (error) {
                console.error('Error saving GitHub token:', error);
                this.showInAppNotification('error', 'GitHub Configuration', `Failed to save token: ${error.message}`);
            }
        }
        
        async testGitHubToken() {
            try {
                const response = await fetch('/api/github/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'test' })
                });
                
                const result = await response.json();
                
                if (result.success && result.test_result === 'valid') {
                    this.showInAppNotification('success', 'GitHub Test', 'GitHub token is working correctly');
                    
                    // Show user info
                    const userInfoDiv = document.getElementById('github-user-info');
                    if (result.user_info) {
                        userInfoDiv.innerHTML = `
                            <div class="flex items-start">
                                <i class="fab fa-github text-gray-700 mr-3 mt-1"></i>
                                <div>
                                    <div class="font-medium text-green-800">${result.user_info.login}</div>
                                    ${result.user_info.name ? `<div class="text-sm text-green-700">${result.user_info.name}</div>` : ''}
                                    ${result.user_info.email ? `<div class="text-xs text-green-600">${result.user_info.email}</div>` : ''}
                                </div>
                            </div>
                        `;
                        userInfoDiv.classList.remove('hidden');
                    }
                } else {
                    throw new Error(result.message || 'Token test failed');
                }
            } catch (error) {
                console.error('Error testing GitHub token:', error);
                this.showInAppNotification('error', 'GitHub Test', `Token test failed: ${error.message}`);
            }
        }
        
        async removeGitHubToken() {
            if (!confirm('Are you sure you want to remove the GitHub token? This will disable GitHub integration.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/github/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'remove' })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    this.showInAppNotification('success', 'GitHub Configuration', 'GitHub token removed successfully');
                    this.updateGitHubStatus(result.config_status);
                    
                    // Hide user info
                    const userInfoDiv = document.getElementById('github-user-info');
                    userInfoDiv.classList.add('hidden');
                    
                    // Clear the input
                    document.getElementById('github-token').value = '';
                } else {
                    throw new Error(result.detail || 'Failed to remove GitHub token');
                }
            } catch (error) {
                console.error('Error removing GitHub token:', error);
                this.showInAppNotification('error', 'GitHub Configuration', `Failed to remove token: ${error.message}`);
            }
        }
        
        toggleGitHubTokenVisibility() {
            const tokenInput = document.getElementById('github-token');
            const toggleBtn = document.getElementById('toggle-github-token');
            const icon = toggleBtn.querySelector('i');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                tokenInput.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
        
        // Jira Methods
        async loadJiraConfig() {
            try {
                const response = await fetch('/api/jira/connection-details');
                if (response.ok) {
                    const data = await response.json();
                    this.updateJiraStatus(data);
                } else {
                    console.error('Failed to load Jira config');
                }
            } catch (error) {
                console.error('Error loading Jira config:', error);
            }
        }
        
        updateJiraStatus(config) {
            if (config.is_configured) {
                this.jiraStatusDiv.className = 'mb-4 p-3 rounded-lg bg-green-50 border border-green-200';
                this.jiraStatusDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-green-700 font-medium">Jira Integration Configured</span>
                    </div>
                    <div class="text-sm text-green-600 mt-1">
                        Connected to: ${config.server_url || 'Unknown Server'}
                        <br>Username: ${config.username || 'Unknown User'}
                    </div>
                `;
            } else {
                this.jiraStatusDiv.className = 'mb-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200';
                this.jiraStatusDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                        <span class="text-yellow-700 font-medium">Jira Integration Not Configured</span>
                    </div>
                    <div class="text-sm text-yellow-600 mt-1">
                        Add your Jira credentials to enable issue tracking and management.
                    </div>
                `;
            }
        }
        
        async saveJiraCredentials() {
            const serverUrl = this.jiraServerUrl.value.trim();
            const username = this.jiraUsername.value.trim();
            const token = this.jiraToken.value.trim();
            const authMethod = this.jiraAuthMethod.value;
            
            if (!serverUrl || !username || !token) {
                this.showInAppNotification('error', 'Jira Configuration', 'Please fill in all Jira credentials');
                return;
            }
            
            try {
                const response = await fetch('/api/jira/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        server_url: serverUrl,
                        username: username,
                        api_token: token,
                        auth_method: authMethod
                    })
                });
                
                if (response.ok) {
                    this.showInAppNotification('success', 'Jira Configuration', 'Jira credentials saved successfully');
                    await this.loadJiraConfig();
                    this.jiraToken.value = ''; // Clear token for security
                } else {
                    throw new Error('Failed to save Jira credentials');
                }
            } catch (error) {
                console.error('Error saving Jira credentials:', error);
                this.showInAppNotification('error', 'Jira Configuration', `Failed to save credentials: ${error.message}`);
            }
        }
        
        async testJiraConnection() {
            try {
                const response = await fetch('/api/jira/test-connection');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    this.showInAppNotification('success', 'Jira Test', 'Jira connection test successful');
                } else {
                    throw new Error(result.message || 'Connection test failed');
                }
            } catch (error) {
                console.error('Error testing Jira connection:', error);
                this.showInAppNotification('error', 'Jira Test', `Connection test failed: ${error.message}`);
            }
        }
        
        async removeJiraCredentials() {
            if (!confirm('Are you sure you want to remove the Jira credentials? This will disable Jira integration.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/jira/credentials', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    this.showInAppNotification('success', 'Jira Configuration', 'Jira credentials removed successfully');
                    this.jiraServerUrl.value = '';
                    this.jiraUsername.value = '';
                    this.jiraToken.value = '';
                    await this.loadJiraConfig();
                } else {
                    throw new Error('Failed to remove Jira credentials');
                }
            } catch (error) {
                console.error('Error removing Jira credentials:', error);
                this.showInAppNotification('error', 'Jira Configuration', `Failed to remove credentials: ${error.message}`);
            }
        }
        
        toggleJiraTokenVisibility() {
            const tokenInput = this.jiraToken;
            const toggleBtn = this.toggleJiraTokenBtn;
            const icon = toggleBtn.querySelector('i');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                tokenInput.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        } // End of AIAssistant class

        // Initialize the AI Assistant when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.aiAssistant = new AIAssistant();
            
            // Ensure models are loaded after initialization
            setTimeout(() => {
                if (window.aiAssistant && window.aiAssistant.loadAvailableModels) {
                    console.log('üîÑ Loading models after initialization...');
                    window.aiAssistant.loadAvailableModels();
                }
            }, 1000);
            
            // Add a global function to manually check status
            window.manualStatusCheck = async function() {
                console.log('Manual status check triggered');
                try {
                    const response = await fetch('/api/auth/status');
                    const status = await response.json();
                    console.log('Manual status check result:', status);
                    window.aiAssistant.updateStatusDisplay(status);
                    return status;
                } catch (error) {
                    console.error('Manual status check error:', error);
                    return null;
                }
            };
            
            // Add a global function to force status update
            window.forceStatusUpdate = function() {
                console.log('Force status update triggered');
                window.aiAssistant.checkStatus();
            };
            
            // Add a simple test function to manually update status
            window.testStatusUpdate = function() {
                console.log('Test status update triggered');
                const testStatus = {
                    google: true,
                    slack: false,
                    github: true,
                    jira: true
                };
                
                // Manually update each element
                const gmailElement = document.getElementById('gmail-status');
                if (gmailElement) {
                    gmailElement.textContent = 'Gmail: Connected';
                    gmailElement.className = 'text-sm text-green-600';
                    console.log('Manually updated Gmail status');
                }
                
                const calendarElement = document.getElementById('calendar-status');
                if (calendarElement) {
                    calendarElement.textContent = 'Calendar: Connected';
                    calendarElement.className = 'text-sm text-green-600';
                    console.log('Manually updated Calendar status');
                }
                
                const contactsElement = document.getElementById('contacts-status');
                if (contactsElement) {
                    contactsElement.textContent = 'Contacts: Connected';
                    contactsElement.className = 'text-sm text-green-600';
                    console.log('Manually updated Contacts status');
                }
                
                const slackElement = document.getElementById('slack-status');
                if (slackElement) {
                    slackElement.textContent = 'Slack: Disconnected';
                    slackElement.className = 'text-sm text-red-600';
                    console.log('Manually updated Slack status');
                }
                
                const githubElement = document.getElementById('github-integration-status');
                if (githubElement) {
                    githubElement.textContent = 'GitHub: Connected';
                    githubElement.className = 'text-sm text-green-600';
                    console.log('Manually updated GitHub status');
                }
                
                // Update AI model status
                const aiModelElement = document.getElementById('ai-model-status');
                if (aiModelElement) {
                    aiModelElement.textContent = 'AI Model: Ollama granite3.3-balanced';
                    aiModelElement.className = 'text-sm text-green-600';
                    console.log('Manually updated AI model status');
                }
            };
             
            // Add voice recording functionality
            const voiceButton = document.getElementById('voice-button');
            if (voiceButton) {
                console.log('Voice button found, adding voice recording functionality');
                
                let isRecording = false;
                let recognition = null;
                
                // Check if speech recognition is available
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = function() {
                        console.log('Voice recognition started');
                        isRecording = true;
                        voiceButton.classList.add('recording');
                        voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                        voiceButton.style.backgroundColor = '#dc2626';
                        voiceButton.title = 'Click to stop recording';
                    };
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        console.log('Voice transcript:', transcript);
                        
                        // Add the transcript to the message input
                        const messageInput = document.getElementById('message-input');
                        if (messageInput) {
                            messageInput.value = transcript;
                        }
                        
                        // Stop recording
                        recognition.stop();
                    };
                    
                    recognition.onend = function() {
                        console.log('Voice recognition ended');
                        isRecording = false;
                        voiceButton.classList.remove('recording');
                        voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                        voiceButton.style.backgroundColor = '#ef4444';
                        voiceButton.title = 'Click to start voice recording';
                    };
                    
                    recognition.onerror = function(event) {
                        console.error('Voice recognition error:', event.error);
                        isRecording = false;
                        voiceButton.classList.remove('recording');
                        voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                        voiceButton.style.backgroundColor = '#ef4444';
                        voiceButton.title = 'Click to start voice recording';
                        
                        // Show user-friendly error message
                        if (event.error === 'not-allowed') {
                            alert('Microphone access denied. Please allow microphone access in your browser settings.');
                        } else if (event.error === 'no-speech') {
                            alert('No speech detected. Please try speaking again.');
                        } else {
                            alert('Voice recognition error: ' + event.error);
                        }
                    };
                    
                    voiceButton.addEventListener('click', function() {
                        if (isRecording) {
                            recognition.stop();
                        } else {
                            // Request microphone permission first
                            navigator.mediaDevices.getUserMedia({ audio: true })
                                .then(function(stream) {
                                    console.log('Microphone permission granted');
                                    recognition.start();
                                })
                                .catch(function(err) {
                                    console.error('Microphone permission denied:', err);
                                    alert('Please allow microphone access to use voice recording.');
                                });
                        }
                    });
                    
                    console.log('Voice recording functionality set up successfully');
                } else {
                    console.log('Speech recognition not supported');
                    voiceButton.disabled = true;
                    voiceButton.title = 'Voice recognition not supported in this browser';
                    voiceButton.style.opacity = '0.5';
                }
            } else {
                console.error('Voice button not found');
            }
        });
     </script>
    <!-- Add this before the closing </body> tag -->
    <script src="/frontend/js/settings.js"></script>
    
    <!-- Simple Status Update Script -->
    <script>
        // Simple function to update status display
        async function updateServiceStatus() {
            try {
                console.log('Updating service status...');
                const response = await fetch('/api/auth/status');
                const status = await response.json();
                console.log('Status received:', status);
                
                // Update Gmail status
                const gmailElement = document.getElementById('gmail-status');
                if (gmailElement) {
                    gmailElement.textContent = `Gmail: ${status.google ? 'Connected' : 'Disconnected'}`;
                    gmailElement.className = `text-sm ${status.google ? 'text-green-600' : 'text-red-600'}`;
                }
                
                // Update Calendar status
                const calendarElement = document.getElementById('calendar-status');
                if (calendarElement) {
                    calendarElement.textContent = `Calendar: ${status.google ? 'Connected' : 'Disconnected'}`;
                    calendarElement.className = `text-sm ${status.google ? 'text-green-600' : 'text-red-600'}`;
                }
                
                // Update Contacts status
                const contactsElement = document.getElementById('contacts-status');
                if (contactsElement) {
                    contactsElement.textContent = `Contacts: ${status.google ? 'Connected' : 'Disconnected'}`;
                    contactsElement.className = `text-sm ${status.google ? 'text-green-600' : 'text-red-600'}`;
                }
                
                // Update Slack status
                const slackElement = document.getElementById('slack-status');
                if (slackElement) {
                    slackElement.textContent = `Slack: ${status.slack ? 'Connected' : 'Disconnected'}`;
                    slackElement.className = `text-sm ${status.slack ? 'text-green-600' : 'text-red-600'}`;
                }
                
                // Update GitHub status
                const githubElement = document.getElementById('github-integration-status');
                if (githubElement) {
                    githubElement.textContent = `GitHub: ${status.github ? 'Connected' : 'Disconnected'}`;
                    githubElement.className = `text-sm ${status.github ? 'text-green-600' : 'text-red-600'}`;
                }
                
                console.log('Status update completed');
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }
        
        // Update status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, updating status...');
            updateServiceStatus();
            
            // Add click handler to refresh button
            const refreshBtn = document.getElementById('refresh-status');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    console.log('Refresh button clicked');
                    updateServiceStatus();
                });
            }
            
            // Add click handler to test button
            const testBtn = document.getElementById('test-status');
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    console.log('Test button clicked');
                    updateServiceStatus();
                });
            }
        });
        
        // Make function globally accessible
        window.updateServiceStatus = updateServiceStatus;
        
        // Simple Chat Function
        async function sendChatMessage(message) {
            try {
                console.log('Sending chat message:', message);
                
                // Add user message to chat
                addChatMessage(message, 'user');
                
                // Check if this is a PR review request and include model preference
                let requestBody = { message };
                
                // If it's a PR review request, include the selected model
                if (message.toLowerCase().includes('review pr') || message.toLowerCase().includes('review pull request')) {
                    const prReviewModel = document.getElementById('pr-review-model')?.value || 'ollama';
                    requestBody.model_preference = prReviewModel;
                    console.log(`Including model preference for PR review: ${prReviewModel}`);
                }
                
                // Send to API
                const response = await fetch('/api/agent/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Chat response:', data);
                    
                    // Add assistant response to chat
                    addChatMessage(data.response, 'assistant');
                    
                    // Speak the AI response using AIAssistant's voice system
                    if (window.aiAssistant && window.aiAssistant.voiceResponsesEnabled) {
                        window.aiAssistant.speakText(data.response);
                    } else {
                        // Fallback: check if voice toggle is enabled and speak directly
                        const voiceToggle = document.getElementById('voice-toggle');
                        if (voiceToggle && voiceToggle.classList.contains('bg-green-500')) {
                            console.log('Using fallback voice synthesis');
                            if ('speechSynthesis' in window) {
                                const utterance = new SpeechSynthesisUtterance(data.response);
                                utterance.rate = 1.5;
                                utterance.volume = 0.9;
                                utterance.lang = 'en-US';
                                speechSynthesis.speak(utterance);
                                console.log('Speaking AI response (fallback):', data.response);
                            }
                        }
                    }
                } else {
                    addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (error) {
                console.error('Chat error:', error);
                addChatMessage('Connection error. Please try again.', 'assistant');
            }
        }
        

        
        function addChatMessage(text, sender) {
            const chatContainer = document.getElementById('chat-container');
            if (!chatContainer) {
                console.error('Chat container not found');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble p-4 rounded-lg max-w-4xl ${
                sender === 'user' ? 'user-message text-white' : 'assistant-message text-white'
            }`;
            
            const contentDiv = document.createElement('div');
            contentDiv.style.cssText = 'white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;';
            
            // Process the text to handle HTML formatting
            let processedText = text;
            
            // Convert <br> tags to line breaks
            processedText = processedText.replace(/<br\s*\/?>/gi, '\n');
            
            // Handle **bold** text
            processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Handle *italic* text
            processedText = processedText.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Handle code blocks with backticks
            processedText = processedText.replace(/`([^`]+)`/g, '<code style="background-color: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            contentDiv.innerHTML = processedText;
            
            bubbleDiv.appendChild(contentDiv);
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Initialize AI Assistant
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing AI Assistant...');
            try {
                window.aiAssistant = new AIAssistant();
                console.log('AI Assistant initialized successfully');
            } catch (error) {
                console.error('Error initializing AI Assistant:', error);
            }
            
            // Add direct chat functionality
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            
            if (messageInput && sendButton) {
                console.log('Setting up chat event listeners');
                
                // Send button click
                sendButton.addEventListener('click', function() {
                    const message = messageInput.value.trim();
                    if (message) {
                        sendChatMessage(message);
                        messageInput.value = '';
                    }
                });
                
                // Enter key press
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const message = messageInput.value.trim();
                        if (message) {
                            sendChatMessage(message);
                            messageInput.value = '';
                        }
                    }
                });
                
                console.log('Chat event listeners set up successfully');
            } else {
                console.error('Message input or send button not found');
            }
            
            // Quick action functionality is already handled in the main event listeners above
            // No need to duplicate the event listeners here
            
            // Add service control functionality
            const checkUnreadEmailsBtn = document.getElementById('check-unread-emails');
            const restartNotificationsBtn = document.getElementById('restart-notifications');
            const checkNotificationStatusBtn = document.getElementById('check-notification-status');
            
            // Function to update unread email badge
            async function updateUnreadBadge() {
                try {
                    const response = await fetch('/api/notifications/unread-count');
                    if (response.ok) {
                        const data = await response.json();
                        const unreadCount = data.unread_count || 0;
                        const unreadBadge = document.getElementById('unread-badge');
                        
                        if (unreadBadge) {
                            if (unreadCount > 0) {
                                unreadBadge.textContent = unreadCount;
                                unreadBadge.classList.remove('hidden');
                                unreadBadge.classList.add('pulse-red');
                                console.log(`Updated unread badge: ${unreadCount} unread emails`);
                            } else {
                                unreadBadge.classList.add('hidden');
                                unreadBadge.classList.remove('pulse-red');
                                console.log('No unread emails, hiding badge');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating unread badge:', error);
                }
            }
            
            // Update unread badge on page load
            updateUnreadBadge();
            
            if (checkUnreadEmailsBtn) {
                checkUnreadEmailsBtn.addEventListener('click', function() {
                    console.log('Check unread emails clicked');
                    sendChatMessage('Show unread emails');
                    // Update the badge after showing unread emails
                    setTimeout(updateUnreadBadge, 1000);
                });
            }
            
            if (restartNotificationsBtn) {
                restartNotificationsBtn.addEventListener('click', function() {
                    console.log('Restart notifications clicked');
                    sendChatMessage('Restart notification service');
                });
            }
            
            if (checkNotificationStatusBtn) {
                checkNotificationStatusBtn.addEventListener('click', function() {
                    console.log('Check notification status clicked');
                    sendChatMessage('Check service status');
                });
            }
            
            // Model switching is now handled in the settings modal
            
            // Add suggestions functionality
            const suggestionButtons = document.querySelectorAll('.suggestion');
            if (suggestionButtons.length > 0) {
                console.log('Setting up suggestion listeners');
                
                suggestionButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        const suggestion = e.currentTarget.dataset.suggestion;
                        console.log('Suggestion clicked:', suggestion);
                        const messageInput = document.getElementById('message-input');
                        if (messageInput) {
                            messageInput.value = suggestion;
                            messageInput.focus();
                        }
                    });
                });
                
                console.log('Suggestion listeners set up successfully');
            }
            
            // Add voice settings functionality
            const testVoiceBtn = document.getElementById('test-voice');
            if (testVoiceBtn) {
                testVoiceBtn.addEventListener('click', function() {
                    console.log('Test voice clicked');
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance("Hello! This is a test of the voice synthesis system.");
                        utterance.rate = 1.5; // 150%
                        utterance.volume = 0.9; // 90%
                        speechSynthesis.speak(utterance);
                    } else {
                        console.log('Speech synthesis not supported');
                    }
                });
            }
            
            // Add simple test voice functionality
            const testVoiceSimpleBtn = document.getElementById('test-voice-simple');
            if (testVoiceSimpleBtn) {
                testVoiceSimpleBtn.addEventListener('click', function() {
                    console.log('Simple test voice clicked');
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance("This is a simple voice test. If you can hear this, voice synthesis is working!");
                        utterance.rate = 1.0;
                        utterance.volume = 1.0;
                        utterance.lang = 'en-US';
                        speechSynthesis.speak(utterance);
                        console.log('Simple voice test started');
                    } else {
                        console.log('Speech synthesis not supported');
                        alert('Speech synthesis not supported in this browser');
                    }
                });
            }
            
            // Add voice control sliders functionality
            const speechRateSlider = document.getElementById('speech-rate');
            const speechVolumeSlider = document.getElementById('speech-volume');
            const rateValueSpan = document.getElementById('rate-value');
            const volumeValueSpan = document.getElementById('volume-value');
            
            if (speechRateSlider && rateValueSpan) {
                speechRateSlider.addEventListener('input', function(e) {
                    rateValueSpan.textContent = e.target.value;
                    console.log('Speech rate changed to:', e.target.value);
                });
            }
            
            if (speechVolumeSlider && volumeValueSpan) {
                speechVolumeSlider.addEventListener('input', function(e) {
                    volumeValueSpan.textContent = e.target.value;
                    console.log('Speech volume changed to:', e.target.value);
                });
            }
            
            console.log('All functionality initialized successfully!');
            
            // Initialize AIAssistant and set up voice functionality
            console.log('Initializing AI Assistant...');
            try {
                window.aiAssistant = new AIAssistant();
                console.log('AI Assistant initialized successfully');
                
                // Enable voice responses by default
                window.aiAssistant.voiceResponsesEnabled = true;
                
                // Update the voice toggle button to show enabled state
                const voiceToggle = document.getElementById('voice-toggle');
                if (voiceToggle) {
                    voiceToggle.classList.remove('bg-gray-500');
                    voiceToggle.classList.add('bg-green-500');
                    voiceToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                    voiceToggle.title = 'Voice responses enabled - Click to disable';
                    console.log('Voice toggle button updated to enabled state');
                } else {
                    console.error('Voice toggle button not found');
                }
            } catch (error) {
                console.error('Error initializing AI Assistant:', error);
            }
            
            // Add PR Review Model Selection functionality
            const prReviewModelSelect = document.getElementById('pr-review-model');
            const currentPrModelSpan = document.getElementById('current-pr-model');
            const testPrReviewBtn = document.getElementById('test-pr-review');
            
            // Initialize PR review model selection
            if (prReviewModelSelect) {
                console.log('Setting up PR review model selection');
                
                // Load saved preference or default to ollama
                const savedModel = localStorage.getItem('pr-review-model') || 'ollama';
                prReviewModelSelect.value = savedModel;
                updateCurrentPrModelDisplay(savedModel);
                
                // Handle model change
                prReviewModelSelect.addEventListener('change', function(e) {
                    const selectedModel = e.target.value;
                    localStorage.setItem('pr-review-model', selectedModel);
                    updateCurrentPrModelDisplay(selectedModel);
                    console.log(`PR review model changed to: ${selectedModel}`);
                });
                
                function updateCurrentPrModelDisplay(model) {
                    if (currentPrModelSpan) {
                        const modelNames = {
                            'ollama': 'Ollama',
                            'gemini': 'Gemini',
                            'openai': 'OpenAI GPT',
                            'granite': 'Granite'
                        };
                        currentPrModelSpan.textContent = modelNames[model] || model;
                    }
                }
                
                // Test PR review button
                if (testPrReviewBtn) {
                    testPrReviewBtn.addEventListener('click', function() {
                        const selectedModel = prReviewModelSelect.value;
                        console.log(`Testing PR review with ${selectedModel}`);
                        sendChatMessage(`review pr https://github.com/openshift/release/pull/66912 using ${selectedModel}`);
                    });
                }
            }
            
            // Add voice toggle functionality
            const voiceToggle = document.getElementById('voice-toggle');
            if (voiceToggle) {
                console.log('Setting up voice toggle functionality');
                voiceToggle.addEventListener('click', function() {
                    console.log('Voice toggle clicked');
                    if (window.aiAssistant) {
                        window.aiAssistant.toggleVoiceResponses();
                    } else {
                        console.error('AI Assistant not initialized');
                        // Fallback: manually toggle voice
                        const isEnabled = voiceToggle.classList.contains('bg-green-500');
                        if (isEnabled) {
                            voiceToggle.classList.remove('bg-green-500');
                            voiceToggle.classList.add('bg-gray-500');
                            voiceToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                            voiceToggle.title = 'Voice responses disabled - Click to enable';
                            console.log('Voice responses disabled (fallback)');
                        } else {
                            voiceToggle.classList.remove('bg-gray-500');
                            voiceToggle.classList.add('bg-green-500');
                            voiceToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                            voiceToggle.title = 'Voice responses enabled - Click to disable';
                            console.log('Voice responses enabled (fallback)');
                        }
                    }
                });
                console.log('Voice toggle functionality set up successfully');
            } else {
                console.error('Voice toggle button not found');
            }
            
            // Add voice recording functionality
            const voiceButton = document.getElementById('voice-button');
            if (voiceButton) {
                console.log('Voice button found, adding voice recording functionality');
                
                let isRecording = false;
                let recognition = null;
                
                // Check if speech recognition is available
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = function() {
                        console.log('Voice recognition started');
                        isRecording = true;
                        voiceButton.classList.add('recording');
                        voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                        voiceButton.style.backgroundColor = '#dc2626';
                        voiceButton.title = 'Click to stop recording';
                    };
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        console.log('Voice transcript:', transcript);
                        
                        // Add the transcript to the message input
                        const messageInput = document.getElementById('message-input');
                        if (messageInput) {
                            messageInput.value = transcript;
                        }
                        
                        // Stop recording
                        recognition.stop();
                    };
                    
                    recognition.onend = function() {
                        console.log('Voice recognition ended');
                        isRecording = false;
                        voiceButton.classList.remove('recording');
                        voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                        voiceButton.style.backgroundColor = '#ef4444';
                        voiceButton.title = 'Click to start voice recording';
                    };
                    
                    recognition.onerror = function(event) {
                        console.error('Voice recognition error:', event.error);
                        isRecording = false;
                        voiceButton.classList.remove('recording');
                        voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                        voiceButton.style.backgroundColor = '#ef4444';
                        voiceButton.title = 'Click to start voice recording';
                        
                        // Show user-friendly error message
                        if (event.error === 'not-allowed') {
                            alert('Microphone access denied. Please allow microphone access in your browser settings.');
                        } else if (event.error === 'no-speech') {
                            alert('No speech detected. Please try speaking again.');
                        } else {
                            alert('Voice recognition error: ' + event.error);
                        }
                    };
                    
                    voiceButton.addEventListener('click', function() {
                        if (isRecording) {
                            recognition.stop();
                        } else {
                            // Request microphone permission first
                            navigator.mediaDevices.getUserMedia({ audio: true })
                                .then(function(stream) {
                                    console.log('Microphone permission granted');
                                    recognition.start();
                                })
                                .catch(function(err) {
                                    console.error('Microphone permission denied:', err);
                                    alert('Please allow microphone access to use voice recording.');
                                });
                        }
                    });
                    
                    console.log('Voice recording functionality set up successfully');
                } else {
                    console.log('Speech recognition not supported');
                    voiceButton.disabled = true;
                    voiceButton.title = 'Voice recognition not supported in this browser';
                    voiceButton.style.opacity = '0.5';
                }
            } else {
                console.error('Voice button not found');
            }
        });
    </script>
</body>
</html> 